"use strict";(self.webpackChunkessentials_security=self.webpackChunkessentials_security||[]).push([[7334],{5680:(e,t,n)=>{n.d(t,{xA:()=>p,yg:()=>d});var a=n(6540);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},u="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},g=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),u=c(n),g=r,d=u["".concat(l,".").concat(g)]||u[g]||h[g]||s;return n?a.createElement(d,i(i({ref:t},p),{},{components:n})):a.createElement(d,i({ref:t},p))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,i=new Array(s);i[0]=g;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[u]="string"==typeof e?e:r,i[1]=o;for(var c=2;c<s;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}g.displayName="MDXCreateElement"},6225:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>c});var a=n(8168),r=(n(6540),n(5680));const s={},i="Stack",o={unversionedId:"Binary Introduction/Taming the Stack/Reading/stack",id:"Binary Introduction/Taming the Stack/Reading/stack",title:"Stack",description:"An Abstract Data Structure",source:"@site/docs/Binary Introduction/Taming the Stack/Reading/stack.md",sourceDirName:"Binary Introduction/Taming the Stack/Reading",slug:"/Binary Introduction/Taming the Stack/Reading/stack",permalink:"/essentials-security/Binary Introduction/Taming the Stack/Reading/stack",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"sidebar",previous:{title:"Data, Data Everywhere",permalink:"/essentials-security/Binary Introduction/Taming the Stack/Reading/data-data-everywhere"},next:{title:"Functions and the Stack",permalink:"/essentials-security/Binary Introduction/Taming the Stack/Reading/functions-and-the-stack"}},l={},c=[{value:"An Abstract Data Structure",id:"an-abstract-data-structure",level:2},{value:"Real Life Use Case",id:"real-life-use-case",level:2},{value:"<code>push</code> and <code>pop</code> Under the Hood",id:"push-and-pop-under-the-hood",level:2}],p={toc:c},u="wrapper";function h(e){let{components:t,...s}=e;return(0,r.yg)(u,(0,a.A)({},p,s,{components:t,mdxType:"MDXLayout"}),(0,r.yg)("h1",{id:"stack"},"Stack"),(0,r.yg)("h2",{id:"an-abstract-data-structure"},"An Abstract Data Structure"),(0,r.yg)("p",null,"The stack, as a data structure, functions on the LIFO (Last In First Out) concept: one can access only one element at a time, and it's always the last one."),(0,r.yg)("p",null,"The two operations accepted by the stack data structure are:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"push")," (add one element at the back)"),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("inlineCode",{parentName:"li"},"pop")," (retrieve the last element, while removing it from the stack)")),(0,r.yg)("h2",{id:"real-life-use-case"},"Real Life Use Case"),(0,r.yg)("p",null,"Enough about abstract data structures for now, let's get down to the OS business!\nEvery process on your system has a stack, used for a plethora of reasons.\nWhile the program stack has a similar behaviour with the abstract data structure from which it got its name, its role is of great interest to attackers and programmers alike:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"it stores the return address")),(0,r.yg)("p",{parentName:"li"}," Have you ever wondered how a program knows how to return and execute the next instruction after a function call?\nHere comes the stack.\nThe return address (meaning the address of the next instruction after a function call) gets ",(0,r.yg)("strong",{parentName:"p"},"pushed")," on the stack right before entering the function and ",(0,r.yg)("strong",{parentName:"p"},"popped")," at the end of the function."),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-asm"},"call my_func\n\n; this is equivalent to\n\ninc rip\npush rip\njmp my_func\n"))),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"it saves the content of the registers")),(0,r.yg)("p",{parentName:"li"}," Let's say we have multiple ",(0,r.yg)("strong",{parentName:"p"},"nested")," functions that all use the same ",(0,r.yg)("inlineCode",{parentName:"p"},"ecx")," register.\nIn this scenario, every nested function call overwrites the original ",(0,r.yg)("inlineCode",{parentName:"p"},"ecx")," value (set in the previous method), therefore producing garbage results and even critical errors.\nAs a result, the stack is used to preserve the values of the affected registers."),(0,r.yg)("p",{parentName:"li"}," For example, corrupting registers would look something like this:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-asm"},"f:\n    mov ecx, 1\n    call g\n\n    ; this should result in ecx = 2,\n    ; however ecx gets corrupted by the function calls\n    inc ecx\n\ng:\n    mov ecx, 128\n    shr ecx, 2\n    call h\n\nh:\n    xor ecx, ecx\n")),(0,r.yg)("p",{parentName:"li"}," We should preserve the register value by saving it on stack:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-asm"},"f:\n    mov ecx, 1\n\n    ; preserve the ecx value\n    push ecx\n    call g\n    ; restore the ecx value, WE ARE SAFE\n    pop ecx\n\n    inc ecx\n\ng:\n    mov ecx, 128\n    shr ecx, 2\n\n    ; preserve the ecx value\n    push ecx\n    call h\n    ; restore the ecx value, WE ARE SAFE\n    pop ecx\n\nh:\n    ; no need to save ecx, there are no further function calls\n    xor ecx, ecx\n"))),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("p",{parentName:"li"},(0,r.yg)("strong",{parentName:"p"},"it stores local variables")),(0,r.yg)("p",{parentName:"li"}," Remember the local variables from C/C++?\nThe ones that were disposable and didn't preserve their value between different function calls?\nWell, surprise!\nThey are stored on the stack."),(0,r.yg)("p",{parentName:"li"}," For instance, the following C function gets translated to Assembly like so:"),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-C"},"void my_func()\n{\n     int a = 5;\n}\n")),(0,r.yg)("pre",{parentName:"li"},(0,r.yg)("code",{parentName:"pre",className:"language-asm"},"my_func:\n     ; preserve the stack frame, a special register\n     push ebp\n     mov ebp, esp\n\n     ; allocate space on stack for an integer\n     sub esp, 4\n     ; initialize the integer with 5\n     mov [esp], 5\n\n     ; restore the stack pointer and the stack frame\n     mov esp, ebp\n     pop ebp\n     ret\n")))),(0,r.yg)("h2",{id:"push-and-pop-under-the-hood"},(0,r.yg)("inlineCode",{parentName:"h2"},"push")," and ",(0,r.yg)("inlineCode",{parentName:"h2"},"pop")," Under the Hood"),(0,r.yg)("p",null,"As you probably already figured, the fact that the stack operates with its last added value only means that we somehow need to store the exact address of the top somewhere.\nHere comes the ",(0,r.yg)("inlineCode",{parentName:"p"},"esp")," register.\nWhenever a ",(0,r.yg)("inlineCode",{parentName:"p"},"push")," or ",(0,r.yg)("inlineCode",{parentName:"p"},"pop")," occurs, this register either gets decreased or increased with the size of the value stored on the stack.\nYou've read it right: the ",(0,r.yg)("strong",{parentName:"p"},(0,r.yg)("inlineCode",{parentName:"strong"},"push")," operation decreases the ",(0,r.yg)("inlineCode",{parentName:"strong"},"esp")," value")," and a ",(0,r.yg)("strong",{parentName:"p"},(0,r.yg)("inlineCode",{parentName:"strong"},"pop")," operation increases it"),"!\nThat's because the stack grows downwards."),(0,r.yg)("p",null,"Why so?\nThink about an array, let's call it ",(0,r.yg)("inlineCode",{parentName:"p"},"arr"),".\nIts elements are consecutive and the one at the lowest address is the first one: ",(0,r.yg)("inlineCode",{parentName:"p"},"arr[0]"),".\nThe next one, at a higher address, is ",(0,r.yg)("inlineCode",{parentName:"p"},"arr[1]")," and so on.\nTherefore, if we place this tack in memory it'll look like this:"),(0,r.yg)("p",null,(0,r.yg)("img",{alt:"stack array",src:n(9639).A})),(0,r.yg)("p",null,(0,r.yg)("img",{alt:"stack growth",src:n(166).A,width:"504",height:"360"})),(0,r.yg)("p",null,"So, the following 4 snippets are equivalent 2 by 2:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-asm"},"push dword 5\n")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-asm"},"sub esp, 4\nmov [esp], dword 5\n")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-asm"},"pop ecx\n")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-asm"},"mov [esp], ecx\nadd esp, 4\n")))}h.isMDXComponent=!0},9639:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/stack-array-afacc7b102fe8cb3b541f9fa895d4ea5.svg"},166:(e,t,n)=>{n.d(t,{A:()=>a});const a="data:image/png;base64,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"}}]);